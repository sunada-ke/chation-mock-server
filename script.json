function addVersion(url){
    var arr = url.split('/')
    var len = arr.length
	if (len > 2 && arr[len - 2] !== '1.0') {
		arr[len] = arr[len - 1]
		arr[len - 1] = '1.0'
	}
    return arr.join('/')
}
function changeWidget(widgets, _ids, widgetsIds){
    return widgets.map(widget => {
			if (typeof widget === 'string') {
				const index = _ids.indexOf(widget)
				if (index > -1) {
					return { widgetId: widgetsIds[index], version: '1.0' }
				} else {
					return { widgetId: widget, version: '1.0' }
				}
			} else {
				return widget
			}
    })
}

db.getCollection('widgets').update({},{$set:{version:'1.0',weight:NumberInt(1)},$unset:{status:'',linkPages:'',widgetFlg:'',widgetPropFlg:''}},false,true)
var widgets = db.getCollection('widgets').find({})
widgets.forEach(item => {
    var url = addVersion(item.url)
    var detailImg = addVersion(item.detailImg)
    var previewImg = addVersion(item.previewImg)
    db.getCollection('widgets').update({_id:item._id},{$set:{widgetId:item.fileName.split('.')[0],url:url,detailImg:detailImg,previewImg:previewImg}})
})
widgets = []
var new_widgets = db.getCollection('widgets').find({})
var _ids = []
var widgetsIds = []
new_widgets.forEach(item => {
	_ids.push(item._id + '')
	widgetsIds.push(item.widgetId)
})
new_widgets = []
var pages = db.getCollection('pages').find({})
pages.forEach(page => {
    var layout = page.layout
    layout.forEach(item => {
		if (item.customized && item.customized.widgetId) {
			const index = _ids.indexOf(item.customized.widgetId)
			if (index > -1) {
				item.customized.widgetId = widgetsIds[index]
			}
		}
        if (item.widgetUrl) {
            item.widgetUrl = addVersion(item.widgetUrl)
            item.version = '1.0'
        }
    })
    var widgets = page.widgets
    if (widgets.length > 0) {
        widgets = changeWidget(page.widgets, _ids, widgetsIds)
    }
    db.getCollection('pages').update({_id:page._id},{$set:{layout:layout,widgets:widgets}})
})
pages = []
var templates = db.getCollection('templates').find({})
templates.forEach(template => {
    var layout = template.layout
    layout.forEach(item => {
		if (item.customized && item.customized.widgetId) {
			const index = _ids.indexOf(item.customized.widgetId)
			if (index > -1) {
				item.customized.widgetId = widgetsIds[index]
			}
		}
        if (item.widgetUrl) {
            item.widgetUrl = addVersion(item.widgetUrl)
            item.version = '1.0'
        }
    })
    var widgets = template.widgets
    if (widgets.length > 0) {
        widgets = changeWidget(template.widgets, _ids, widgetsIds)
    }
    db.getCollection('templates').update({_id:template._id},{$set:{layout:layout,widgets:widgets}})
})

db.getCollection('siteJs').update({},{$set:{lintMessages:[],resultFlg: 'normal'}},false,true)
db.getCollection('widgets').update({},{$set:{lintMessages:[],resultFlg: 'normal'}},false,true)
db.getCollection('pages').update({'js.isSiteJs':false},{$set:{'js.$.resultFlg':'normal','js.$.lintMessages':[]}})